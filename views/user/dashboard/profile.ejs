<style>
.modal {
    display: none; /* Initially hidden */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    visibility: hidden; /* Hidden until modal is shown */
}

.modal.show {
    display: flex;
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background-color: #fff;
    padding: 30px 20px;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
    transform: translateY(-20px);
    transition: transform 0.3s ease;
}

.modal.show .modal-content {
    transform: translateY(0);
}

.profile-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .profile-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .profile-image-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 2rem;
        transition: transform 0.3s ease;
    }

    .profile-image-container:hover {
        transform: scale(1.05);
    }

    .profile-image {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #ff9f43;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .profile-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
        margin-top: 2rem;
    }

    .detail-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .detail-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .edit-button {
        background: #ff9f43;
        color: white;
        border: none;
        border-radius: 50%;
        aspect-ratio: 1;
        height: 100%;
        min-height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        position: absolute;
        right: -40px;
        top: 50%;
        transform: translateY(-50%);
        box-shadow: 0 2px 8px rgba(255, 159, 67, 0.3);
    }

    .edit-button:hover {
        background: #ff9f43;
        box-shadow: 0 4px 12px rgba(255, 159, 67, 0.5);
        filter: brightness(1.1);
    }

    .input-group {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .form-input {
        background-color: #fff5e6;
        border: 2px solid #ffd9b3;
        border-radius: 8px;
        padding: 0.75rem;
        width: 100%;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-input:focus {
        border-color: #ff9f43;
        box-shadow: 0 0 0 3px rgba(255, 159, 67, 0.2);
        outline: none;
    }

    @media (max-width: 768px) {
        .profile-details {
            grid-template-columns: 1fr;
        }
    }

    /* Animation for cards */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .detail-card {
        animation: fadeInUp 0.5s ease forwards;
    }

    .detail-card:nth-child(2) {
        animation-delay: 0.1s;
    }

    .detail-card:nth-child(3) {
        animation-delay: 0.2s;
    }

    .detail-card:nth-child(4) {
        animation-delay: 0.3s;
    }

    .input-group {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    position: relative;
}

.edit-button {
    position: absolute;
    right: -40px;
    top: 50%;
    transform: translateY(-50%);
}

.password-input-group {
    position: relative;
    margin-bottom: 1rem;
}

.password-toggle {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #666;
    padding: 5px;
}

.password-toggle:hover {
    color: #ff9f43;
}

.modal-close {
    position: absolute;
    right: 1rem;
    top: 1rem;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    transition: color 0.2s ease;
}

.modal-close:hover {
    color: #ff9f43;
}

.mb-4 {
    margin-bottom: 1rem;
    padding-right: 45px;  /* Add padding to accommodate the edit button */
}

.validation-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.validation-item i {
    width: 1rem;
}
.validation-item.valid {
    color: #22c55e;
}
.validation-item.invalid {
    color: #ef4444;
}

.toastify {
    width: fit-content !important;
    min-width: 300px !important;
    max-width: 400px !important;
    padding: 12px 24px !important;
    border-radius: 8px !important;
    font-family: Arial, sans-serif !important;
    font-size: 16px !important;
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
    z-index: 9999 !important;
    opacity: 0;
    transform: translateY(-20px);
    animation: toast-in 0.3s ease-in-out forwards;
}

@keyframes toast-in {
    0% {
        opacity: 0;
        transform: translateY(-20px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

.toastify-progress {
    background: linear-gradient(to right, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.5)) !important;
    height: 4px !important;
    bottom: 0 !important;
    border-radius: 0 0 8px 8px !important;
}

.toastify-close {
    opacity: 0.7 !important;
    padding: 0 8px !important;
    font-size: 18px !important;
    transition: opacity 0.2s ease !important;
}

.toastify-close:hover {
    opacity: 1 !important;
}
</style>
<!-- Header -->
<%- include('../../partials/user/header') %>

    <!-- Main Content -->
<main class="flex">
    <!-- Sidebar -->
    <%- include('../../partials/user/dashboard_sideBar') %>

    <section class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-image-container">
                <img class="profile-image"
                    src="https://storage.googleapis.com/a1aa/image/7ptvGJTizcosGR06svePzsBNtU6vyjyt8O63NKEYuyceo9pTA.jpg"
                    alt="User Profile Image">
            </div>
            <h2 class="text-2xl font-bold mb-4">Personal Information</h2>
        </div>

        <!-- Profile Details -->
        <form id="profileForm" action="/user/dash/saveUserDetails" method="post" onsubmit="handleProfileSubmit(event)">
            <div class="profile-details">
                <!-- Left Column -->
                <div class="detail-card">
                    <!-- Username -->
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Username</label>
                        <input class="form-input" value="<%= user.username %>" type="text" name="username" placeholder="Username">
                    </div>

                    <!-- Full Name -->
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Full Name</label>
                        <div class="input-group">
                            <label id="fullname_label" class="form-input"><%= user.fullname %></label>
                            <input id="fullname_input" style="display:none;" class="form-input" value="<%= user.fullname ? user.fullname : '' %>" type="text" name="fullname" placeholder="Full Name">
                            <button type="button" id="fullname_edit" class="edit-button" onclick="fullnameEditing()">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Gender -->
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Gender</label>
                        <div class="input-group">
                            <div id="gender_display">
                                <label id="gender_label" class="form-input"><%= user.gender %></label>
                                <button type="button" id="gender_edit" class="edit-button" onclick="genderEditing()">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="detail-card">
                    <!-- Email -->
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Email Address</label>
                        <div class="form-input flex items-center">
                            <%= user.email %>
                            <% if(user.isGoogleUser){ %>
                                <img src="/images/user/google_logo.png" class="w-6 h-6 ml-2">
                            <% } %>
                        </div>
                    </div>

                    <!-- Phone -->
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Phone</label>
                        <div class="input-group">
                            <label id="phone_label" class="form-input"><%= user.phone %></label>
                            <input id="phone_input" style="display:none;" class="form-input" value="<%= user.phone %>" type="text" name="phone" placeholder="Phone">
                            <button type="button" id="phone_edit" class="edit-button" onclick="phoneEditing()">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Join Date -->
                    <div class="mb-4">
                        <label class="block font-bold mb-2">Joined At</label>
                        <div class="form-input">
                            <%= user.createdAt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center gap-4 mt-8">
                <button type="submit" class="px-6 py-2 bg-orange-400 text-white rounded-lg hover:bg-orange-500 transition-colors">
                    Save Changes
                </button>
                <button type="button" onclick="openModal()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    Change Password
                </button>
                <button type="button" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Delete Account
                </button>
            </div>
        </form>
    </section>
</main>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 class="text-2xl font-bold mb-4">Change Password</h2>
        <form id="passwordForm" class="space-y-4">
            <div class="password-input-group">
                <input type="password" class="form-input" id="newPassword" oninput="validatePasswordOnInput(this.value)" required placeholder="New Password">
                <span class="password-toggle" onclick="togglePassword('newPassword')">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <div class="validation-feedback space-y-1 text-sm"></div>
            <div class="password-input-group">
                <input type="password" class="form-input" id="cfmPassword" oninput="checkPasswordMatch()" required placeholder="Confirm Password">
                <span class="password-toggle" onclick="togglePassword('cfmPassword')">
                    <i class="fas fa-eye"></i>
                </span>
            </div>
            <div id="match-feedback" class="text-sm"></div>
            <button type="button" class="w-full py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors" onclick="changePassword()">
                Update Password
            </button>
        </form>
        <div id="message" class="mt-4 text-center hidden"></div>
    </div>
</div>
    <!-- Footer -->
    <%- include('../../partials/user/footer') %>
<script>
function phoneEditing() {
    const label = document.getElementById('phone_label');
    const input = document.getElementById('phone_input');

    if (label.style.display !== 'none') {
        label.style.display = 'none';
        input.style.display = 'block';
        input.focus();
    } else {
        label.style.display = 'block';
        input.style.display = 'none';
    }
}

function fullnameEditing() {
    const label = document.getElementById('fullname_label');
    const input = document.getElementById('fullname_input');

    if (label.style.display !== 'none') {
        label.style.display = 'none';
        input.style.display = 'block';
        input.focus(); // Optional: focus the input for user convenience
    } else {
        label.style.display = 'block';
        input.style.display = 'none';
    }
}

    function openModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.add('show');
    }

    function closeModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none'; // Hide after transition ends
        }, 300);
    }

    function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = event.currentTarget.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

    function validatePassword(password) {
        // Password requirements
        const minLength = 8;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumbers = /\d/.test(password);
        const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        const errors = [];
        if (password.length < minLength) {
            errors.push(`Password must be at least ${minLength} characters long`);
        }
        if (!hasUpperCase) {
            errors.push("Password must contain at least one uppercase letter");
        }
        if (!hasLowerCase) {
            errors.push("Password must contain at least one lowercase letter");
        }
        if (!hasNumbers) {
            errors.push("Password must contain at least one number");
        }
        if (!hasSpecialChar) {
            errors.push("Password must contain at least one special character");
        }

        return errors;
    }

    // Function to change the password
    async function changePassword() {
        const newPassword = document.getElementById('newPassword').value;
        const cfmPassword = document.getElementById('cfmPassword').value;
        const messageElement = document.getElementById('message');
        
        // First validate password requirements
        const passwordErrors = validatePassword(newPassword);
        if (passwordErrors.length > 0) {
            messageElement.innerHTML = passwordErrors.join('<br>');
            messageElement.classList.remove('hidden');
            messageElement.style.color = 'red';
            return;
        }

        // Then check if passwords match
        if (newPassword !== cfmPassword) {
            messageElement.textContent = "Passwords don't match";
            messageElement.classList.remove('hidden');
            messageElement.style.color = 'red';
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.classList.add('hidden')
            }, 3000);
            return;
        }

        try {
            // Make the POST request to update password
            const response = await axios.post('/user/changePassword', { password: newPassword });
            console.log(response.data)
            if(response.data === 200){
                Toastify({
                    text: "Password updated successfully!",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(135deg, rgba(238, 174, 202, 0.9), rgba(148, 187, 233, 0.9))",
                    stopOnFocus: true,
                    className: "toast_style"
                }).showToast();
            }
            // Display success message
            messageElement.textContent = 'Password updated successfully!';
            messageElement.classList.remove('hidden');
            messageElement.style.color = 'green';
            setTimeout(() => closeModal(), 1000);
        } catch (error) {
            Toastify({
                text: error.response?.data || "Error updating password",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(135deg, rgba(255, 121, 121, 0.9), rgba(255, 182, 193, 0.9))",
                stopOnFocus: true,
                className: "toast_style"
            }).showToast();
            messageElement.textContent = 'Error updating password. Please try again.';
            messageElement.classList.remove('hidden');
            messageElement.style.color = 'red';
        }
    }

    function genderEditing() {
        const edit = document.getElementById('gender_edit')
        const gender_label = document.getElementById('gender_label')
        const genderDisplay = document.getElementById('gender_display');
        
        // Check if we're already in edit mode
        const existingInput = genderDisplay.querySelector('.gender-input-div');
        if (existingInput) {
            // If in edit mode, cancel editing and restore original view
            existingInput.remove();
            gender_label.style.display = '';
            edit.style.display = '';
            return;
        }

        if (gender_label) {
            gender_label.style.display = 'none';
            edit.style.display = 'none'
        }

        // Create a new div for the gender select
        const genderInputDiv = document.createElement('div');
        genderInputDiv.classList.add('gender-input-div', 'flex', 'items-center', 'gap-2');

        // Create select element
        const select = document.createElement('select');
        select.classList.add('form-input', 'bg-yellow-50', 'border-orange-200', 'focus:border-orange-400', 'focus:ring-orange-400');
        
        // Define the gender options
        const genderOptions = ['Male', 'Female', 'Others'];
        
        // Add placeholder option
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select Gender';
        placeholder.disabled = true;
        placeholder.selected = true;
        select.name = 'gender';
        select.appendChild(placeholder);

        // Add gender options
        genderOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            if (option === gender_label.textContent.trim()) {
                optionElement.selected = true;
            }
            select.appendChild(optionElement);
        });

        // Add cancel button
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.classList.add('text-red-500', 'ml-2');
        cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
        cancelBtn.onclick = () => {
            genderInputDiv.remove();
            gender_label.style.display = '';
            edit.style.display = '';
        };

        // Add elements to the container
        genderInputDiv.appendChild(select);
        genderInputDiv.appendChild(cancelBtn);

        // Append the new input div to the parent container
        genderDisplay.appendChild(genderInputDiv);
        
        // Focus the select
        select.focus();
    }

    function validatePasswordOnInput(password) {
        const validationDiv = document.querySelector('.validation-feedback');
        const requirements = [
            { test: p => p.length >= 8, text: "At least 8 characters" },
            { test: p => /[A-Z]/.test(p), text: "One uppercase letter" },
            { test: p => /[a-z]/.test(p), text: "One lowercase letter" },
            { test: p => /\d/.test(p), text: "One number" },
            { test: p => /[!@#$%^&*(),.?":{}|<>]/.test(p), text: "One special character" }
        ];

        // Clear previous feedback
        validationDiv.innerHTML = '';

        // Add validation items
        requirements.forEach(req => {
            const isValid = req.test(password);
            const item = document.createElement('div');
            item.className = `validation-item ${isValid ? 'valid' : 'invalid'}`;
            item.innerHTML = `
                <i class="fas ${isValid ? 'fa-check' : 'fa-times'}"></i>
                <span>${req.text}</span>
            `;
            validationDiv.appendChild(item);
        });

        // Also check password match if confirm password has value
        checkPasswordMatch();
    }

    function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const cfmPassword = document.getElementById('cfmPassword').value;
        const matchFeedback = document.getElementById('match-feedback');

        if (cfmPassword) {
            const matches = newPassword === cfmPassword;
            matchFeedback.className = matches ? 'text-green-500' : 'text-red-500';
            matchFeedback.innerHTML = `
                <div class="validation-item ${matches ? 'valid' : 'invalid'}">
                    <i class="fas ${matches ? 'fa-check' : 'fa-times'}"></i>
                    <span>Passwords ${matches ? 'match' : 'do not match'}</span>
                </div>
            `;
        } else {
            matchFeedback.innerHTML = '';
        }
    }

    async function handleProfileSubmit(event) {
        event.preventDefault();
        const form = event.target;
        
        try {
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (value !== '') {  // Only include non-empty values
                    data[key] = value;
                }
            });

            const response = await axios.post('/user/dash/saveUserDetails', data);
            
            if (response.status === 200) {
                Toastify({
                    text: "Profile updated successfully!",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #00b09b, #96c93d)",
                        border: "1px solid rgba(0, 176, 155, 0.3)"
                    },
                    progressBar: true,
                    stopOnFocus: false,
                    destination: false
                }).showToast();

                // Wait for toast to show then reload
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        } catch (error) {
            console.error('Error:', error);
            Toastify({
                text: error.response?.data || "An error occurred while updating profile",
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    border: "1px solid rgba(255, 95, 109, 0.3)"
                },
                progressBar: true,
                stopOnFocus: false
            }).showToast();
        }
    }

    setTimeout(() => {
        const successDiv = document.getElementById('success_div');
        const errorDiv = document.getElementById('error_div');
        const successMessage = document.getElementById("success_message");
        const errorMessage = document.getElementById("error_message")

        if (successMessage.textContent !== '') {
            successDiv.style.opacity = "0";
            successMessage.textContent = ''
            setTimeout(() => successDiv.style.display = "none", 300); // Remove from view
        }

        if (errorMessage.textContent !== '') {
            errorDiv.style.opacity = "0";
            errorMessage.textContent = ''
            setTimeout(() => errorDiv.style.display = "none", 300); // Remove from view
        }
    }, 3000);
</script>