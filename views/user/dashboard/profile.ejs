<style>
.modal {
    display: none; /* Initially hidden */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    visibility: hidden; /* Hidden until modal is shown */
}

.modal.show {
    display: flex;
    opacity: 1;
    visibility: visible;
}

.modal-content {
    background-color: #fff;
    padding: 30px 20px;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
    transform: translateY(-20px);
    transition: transform 0.3s ease;
}

.modal.show .modal-content {
    transform: translateY(0);
}
</style>
<!-- Header -->
<%- include('../../partials/user/header') %>

    <!-- Main Content -->
    <main class="flex">
        <!-- Sidebar -->
        <%-include('../../partials/user/dashboard_sideBar')  %>

        <!-- Main Section -->
        <% if (successMessage) { %>
            <div id="success_div" class="bg-green-500 text-white p-2 mb-5 text-center rounded transition-opacity duration-500 ease-in-out">
                <p id="success_message"><%= successMessage%></p>
            </div>
        <% } %>

        <% if (errorMessage) { %>
            <div id="error_div" class="bg-red-600 text-white p-2 mb-5 text-center rounded transition-opacity duration-500 ease-in-out">
                <p id="error_message"><%= errorMessage %></p>
            </div>
        <% } %>
        <section class="p-6 w-4/5">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Personal Information</h2>
            </div>
            <form class="flex" action="/user/dash/saveUserDetails" method="post">
                <div class="space-y-4 w-3/4">
                    <% if(user.username && user.username!=='undefined'){ %>
                        <div>
                            <label class="block font-bold">Username</label>
                            <!-- <div class="bg-yellow-100 p-2 rounded"><%= user.username %></div> -->
                            <div>
                                <input class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" value="<%= user.username %>" type="text" name="username" placeholder="Username">
                            </div>
                        </div>
                    <% } else { %>
                        <div>
                            <input class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" type="text" name="username" placeholder="Username">
                        </div>
                    <% } %>
                    <% if(user.fullname){ %>
                        <div>
                            <label class="block font-bold">Name</label>
                            <div>
                                <input class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" value="<%= user.fullname %>" type="text" name="fullname" placeholder="Fullname">
                            </div>
                            <!-- <div class="bg-yellow-100 p-2 rounded"><%= user.fullname %></div> -->
                        </div>
                    <% } else { %>
                        <div>
                            <input class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" type="text" name="fullname" placeholder="Fullname">
                        </div>
                    <% } %>
                    <% if(user.gender){ %>
                        <div id="gender_display">
                            <label id="gender_label" class="bg-yellow-100 font-bold p-2 rounded inline-flex">Gender: <%= user.gender %></label>
                            <span><button type="button" id="gender_edit" class="fas fa-pen" onclick="genderEditing()"></button></span>
                        </div>
                    <% } else { %>
                        <div id="gender_input">
                            <label class="block font-bold">Gender</label>
                            <div class="bg-yellow-100 placeholder-orange-300 w-full p-2 rounded flex space-x-4">
                                <span class="bg-orange-300 rounded-md px-2">
                                    <input type="radio" name="gender" value="Male">
                                    <label>Male</label>
                                </span>
                                <span class="bg-orange-300 rounded-md px-2">
                                    <input type="radio" name="gender" value="Female">
                                    <label>Female</label>
                                </span>
                                <span class="bg-orange-300 rounded-md px-2">
                                    <input type="radio" name="gender" value="Others">
                                    <label>Others</label>
                                </span>
                            </div>
                        </div>
                    <% } %>
                    <div>
                        <label class="block font-bold">Email Address</label>
                        <div class="bg-yellow-100 p-2 rounded items-center"><%= user.email %>
                            <% if(user.isGoogleUser){ %>
                                <span class="inline-flex items-center">
                                    <img src="/images/user/google_logo.png" class="w-6 h-6">
                                </span>
                            <% } %>
                        </div>
                    </div>
                    <% if(user.phone){ %>
                        <div>
                            <label class="block font-bold">Phone</label>
                            <div>
                                <input class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" value="<%= user.phone %>" type="text" name="phone" placeholder="Phone">
                            </div>
                            <!-- <div class="bg-yellow-100 p-2 rounded"><%= user.phone %></div> -->
                        </div>
                    <% } %>
                    <div>
                        <label class="block font-bold">Joined At: <%= user.createdAt %></label>
                    </div>
                    <div>
                                               
                        <button type="button" onclick="openModal()" class="btn bg-orange-300 text-white rounded-md">Change Password?</button>
                    </div>
                    <button class="btn btn-primary" type="submit">Save edits</button>
                </div>
                <div class="w-1/4 h-full ml-4 flex justify-center">
                    <div class="w-full h-full rounded-full border border-black overflow-hidden flex items-center justify-center">
                        <img 
                            class="object-cover w-full h-full"
                            src="https://storage.googleapis.com/a1aa/image/7ptvGJTizcosGR06svePzsBNtU6vyjyt8O63NKEYuyceo9pTA.jpg"
                            alt="User Profile Image">
                            <!-- <span class="absolute bottom-0 right-0 bg-white p-1 rounded-full">
                                <i class="fas fa-pen w-4 h-4"></i>
                            </span> -->
                    </div>                    
                </div>
            </form>
            <div class="flex justify-center">
                <button class="bg-red-500 p-2 text-white rounded-full">Delete Account</button>
            </div>
            <!-- Password Change Modal -->
            <div id="passwordModal" class="modal hidden">
                <div class="modal-content">
                    <span class="inline-flex close-button text-right text-lg cursor-pointer" onclick="closeModal()">Ã—</span>
                    <h2 class="font-bold">Change Password</h2>
                    <form id="passwordForm" class="flex flex-col gap-2 space-y-2">
                        <input type="password" class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" id="newPassword" required placeholder="New Password">
                        <input type="password" class="bg-yellow-100 placeholder-orange-300 border border-black w-full p-2 rounded" id="cfmPassword" required placeholder="Confirm Password">
                        <button type="button" class="btn bg-orange-500 text-white rounded-md" onclick="changePassword()">Update Password</button>
                    </form>
                    <div id="message" class="hidden"></div>
                </div>
            </div> 
        </section>
    </main>

    <!-- Footer -->
    <%- include('../../partials/user/footer') %>
<script>
    function openModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.add('show');
    }

    function closeModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none'; // Hide after transition ends
        }, 300);
    }

    // Function to change the password
    async function changePassword() {
        const newPassword = document.getElementById('newPassword').value;
        const cfmPassword = document.getElementById('cfmPassword').value;
        const messageElement = document.getElementById('message');
        if (newPassword !== cfmPassword) {
            messageElement.textContent = "Passwords doesn't match"
            messageElement.classList.remove('hidden');
            messageElement.style.color = 'red';
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.classList.add('hidden')
            }, 1000);
        } else {
            try {
                // Make the POST request to update password
                const response = await axios.post('/user/changePassword', { password: newPassword });
                console.log(response.data)
                if(response.data === 200){
                    Toastify({
                        text: response.data,
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(135deg, rgba(238, 174, 202, 0.9), rgba(148, 187, 233, 0.9))",
                        stopOnFocus: true,
                        className: "toast_style"
                    }).showToast();
                }
                // Display success message
                messageElement.textContent = 'Password updated successfully!';
                messageElement.classList.remove('hidden');
                messageElement.style.color = 'green';
                setTimeout(() => closeModal(), 1000);
            } catch (error) {
                Toastify({
                        text: error.data,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(135deg, rgba(255, 121, 121, 0.9), rgba(255, 182, 193, 0.9))",
                        stopOnFocus: true,
                        className: "toast_style"
                    }).showToast();
                console.error(error.response?.data || error.message); // Log the error message
                messageElement.textContent = 'Error updating password. Please try again.';
                messageElement.classList.remove('hidden');
                messageElement.style.color = 'red';
                setTimeout(() => closeModal(), 1000);
            }
        }
    }

    function genderEditing() {
        const edit = document.getElementById('gender_edit')
        const gender_label = document.getElementById('gender_label')
        const genderDisplay = document.getElementById('gender_display');
        if (gender_label) {
            gender_label.style.display = 'none';
            edit.style.display = 'none'
        }

        // Create a new div for the gender input options
        const genderInputDiv = document.createElement('div');
        genderInputDiv.classList.add('bg-yellow-100', 'p-2', 'rounded', 'flex', 'space-x-4');

        const newLabel = document.createElement('label')
        newLabel.textContent = 'Gender'
        newLabel.classList.add('font-bold')
        // Define the gender options
        const genderOptions = ['Male', 'Female', 'Others'];

        // Loop through each option to create radio buttons and labels
        genderOptions.forEach(option => {
            const span = document.createElement('span');
            span.classList.add('bg-orange-300', 'rounded-md', 'px-2');

            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'gender';
            input.value = option;

            const label = document.createElement('label');
            label.textContent = option;

            span.appendChild(input);
            span.appendChild(label);
            genderInputDiv.appendChild(span);
        });

        // Append the new input div to the parent container
        genderDisplay.appendChild(newLabel)
        genderDisplay.appendChild(genderInputDiv);
    }

    setTimeout(() => {
        const successDiv = document.getElementById('success_div');
        const errorDiv = document.getElementById('error_div');
        const successMessage = document.getElementById("success_message");
        const errorMessage = document.getElementById("error_message")

        if (successMessage.textContent !== '') {
            successDiv.style.opacity = "0";
            successMessage.textContent = ''
            setTimeout(() => successDiv.style.display = "none", 300); // Remove from view
        }

        if (errorMessage.textContent !== '') {
            errorDiv.style.opacity = "0";
            errorMessage.textContent = ''
            setTimeout(() => errorDiv.style.display = "none", 300); // Remove from view
        }
    }, 3000);
</script>